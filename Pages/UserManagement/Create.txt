using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using MySql.Data.MySqlClient;


namespace AgapayAidSystem.Pages.UserManagement
{
	public class CreateModel : PageModel
    {
		public UserInfo userInfo = new UserInfo();
		public String errorMessage = "";
		public String successMessage = "";

		public void OnGet()
		{
		}

		public void OnPost()
		{
			if (!ModelState.IsValid)
			{
				errorMessage = "Please correct the errors below.";
				return;
			}

			// Get the selected userType directly from the form
			userInfo.userType = Request.Form["userType"];

			// Validate userType
			if (string.IsNullOrEmpty(userInfo.userType))
			{
				errorMessage = "Please select a user type.";
				return;
			}

			else if (userInfo.userType != "Admin" && userInfo.userType != "EC Staff" && userInfo.userType != "LGU Staff")
			{
				errorMessage = "Invalid user type. Choose from Admin, EC Staff, LGU Staff.";
				return;
			}

			// Save the new user into the database
			try
			{
				string connectionString = "server=localhost;user=root;database=agapayaid;port=3306;password=12345;";
				using (MySqlConnection connection = new MySqlConnection(connectionString))
				{
					connection.Open();
					String sql = "INSERT INTO user (userType) VALUES (@userType);";

					using (MySqlCommand command = new MySqlCommand(sql, connection))
					{
						command.Parameters.AddWithValue("@userType", userInfo.userType);
						command.ExecuteNonQuery();
					}
				}
			}
			catch (Exception ex)
			{
				errorMessage = ex.Message;
				return;
			}

			userInfo.userType = "";

			Response.Redirect("/UserManagement/Index");
		}
	}
}


@page
@model AgapayAidSystem.Pages.UserManagement.CreateModel
@{
}

<h1 class="text-center display-4">New User</h1>

@if (Model.errorMessage.Length > 0)
{
	<div class="alert alert-warning alert-dismissible fade show" role="alert">
		<strong>@Model.errorMessage</strong>
		<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
	</div>
}

<form method="POST">
	<div class="row mb-3">
		<label class="col-sm-3 col-form-label">User Type</label>
		<div class="col-sm-6">
			<div class="form-check">
				<input class="form-check-input" type="radio" name="userType" value="Admin" id="adminRadio"
					@if (Model.userInfo.userType == "Admin") { <text>checked</text> }>
				<label class="form-check-label" for="adminRadio">Admin</label>
			</div>
			<div class="form-check">
				<input class="form-check-input" type="radio" name="userType" value="LGU Staff" id="lguRadio"
					@if (Model.userInfo.userType == "LGU Staff") { <text>checked</text> }>
				<label class="form-check-label" for="lguRadio">LGU Staff</label>
			</div>
			<div class="form-check">
				<input class="form-check-input" type="radio" name="userType" value="EC Staff" id="ecRadio"
				@if (Model.userInfo.userType == "EC Staff") { <text>checked</text> }>
				<label class="form-check-label" for="ecRadio">EC Staff</label>
			</div>
		</div>
	</div>

	<input type="hidden" name="userInfo.userType" value="@Model.userInfo.userType" />

	@if (Model.successMessage.Length > 0)
	{
		<div class="row-mb-3">
			<div class="col-sm-9">
				<div class="alert alert-success alert-dismissible fade show" role="alert">
					<strong>@Model.successMessage</strong>
					<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
				</div>
			</div>
		</div>
	}

	<div class="row mb-3">
		<div class="offset-sm-3 col-sm-3 d-grid">
			<!-- button type="submit" class="btn btn-primary">Next</!button -->
			<button type="button" class="btn btn-primary" onclick="redirectToNextPage()">Next</button>
		</div>
		<div class="col-sm-3 d-grid">
			<a class="btn btn-outline-primary" href="/UserManagement/Index" role="button">Cancel</a>
		</div>
	</div>
</form>

<script>
	// JavaScript function to redirect based on userType
	function redirectToNextPage() {
		var userType = document.querySelector('input[name="userType"]:checked').value;
		var userID = @Model.userInfo.userID;

		// Redirect based on userType
		if (userType === "Admin") {
			window.location.href = "/UserManagement/CreateAdmin?userID=" + userID;
		} else if (userType === "LGU Staff") {
			window.location.href = "/UserManagement/CreateLGUStaff?userID=" + userID;
		} else if (userType === "EC Staff") {
			window.location.href = "/UserManagement/CreateECStaff?userID=" + userID;
		}
	}
</script>