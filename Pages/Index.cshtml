@page
@model IndexModel
@{
    ViewData["Title"] = "Home";
}

@{
    var UserId = HttpContext.Session.GetString("UserId");
    var UserType = HttpContext.Session.GetString("UserType");
}

@if (UserType == "Admin")
{
    Layout = "_Layout";
}
else if (UserType == "LGU Staff")
{
    Layout = "_Layout - LGU";
}
else if (UserType == "EC Staff")
{
    Layout = "_Layout - ECStaff";
}
else
{
    Layout = "_Login";
}

<!-- Alert Banners -->
@if (!string.IsNullOrEmpty(Request.Query["successMessage"]))
{
    <div id="success-notification" class="position-fixed top-0 end-0 p-3" style="z-index: 1000;">
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <strong>@Request.Query["successMessage"]</strong>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    </div>

    <script>
        const successNotification = document.getElementById('success-notification');
        if (successNotification) {
            setTimeout(function () {
                successNotification.style.display = 'none';
            }, 5000); // 5000 milliseconds = 5 seconds
        }
    </script>
}

@if (!string.IsNullOrEmpty(Model.errorMessage))
{
    <div class="position-fixed top-0 end-0 p-3" style="z-index: 1000;">
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
            <strong>Error: @Model.errorMessage</strong>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    </div>
}

@if (!string.IsNullOrEmpty(Request.Query["errorMessage"]))
{
    <div class="position-fixed top-0 end-0 p-3" style="z-index: 1000;">
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
            <strong>Error: @Request.Query["errorMessage"]</strong>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    </div>
}

<style>
    body{
        background-color:#f8f9fa !important;
    }

    /* Adjust the size of the DataTable search input */
    div.dataTables_wrapper div.dataTables_filter input {
        width: 150px;
        margin-right: 10px;
    }

    .carousel-caption{
        top: 50%;
        transform: translateY(-50%);
        bottom: initial;
    }
 </style>

<!--MAIN-->
@section Dashboard {
    <div id="myCarousel" class="carousel slide text-white" data-bs-ride="carousel" data-bs-touch="false" data-bs-interval="2000">
        <div class="carousel-indicators">
            <button type="button" data-bs-target="#myCarousel" data-bs-slide-to="0" class="" aria-label="Slide 1"></button>
            <button type="button" data-bs-target="#myCarousel" data-bs-slide-to="1" aria-label="Slide 2" class=""></button>
            <button type="button" data-bs-target="#myCarousel" data-bs-slide-to="2" aria-label="Slide 3" class="active" aria-current="true"></button>
        </div>
        <div class="carousel-inner">
            <div class="carousel-item">
                <img src="/images/ec1img.png" class="d-block w-100" alt="EC1 Image">
                <div class="carousel-caption text-start">
                    <div class="col-lg-6 col-md-12 p-lg-5 mx-auto my-5">
                        <h1 class="text-white d-none d-sm-block">“Together, we stand stronger in the face of adversity.”</h1>
                        <br class="d-none d-lg-block"/>
                        <p class="d-none d-lg-block">
                            Agapay Aid is a web-based application dedicated to aiding the disaster relief efforts in the Philippines.
                            Our application streamlines the management of evacuation centers, ensuring efficient resource allocation, equitable relief goods distribution, staff coordination, and seamless registration of evacuees.
                        </p>
                        <br class="d-none d-lg-block"/>
                        <p class="d-none d-lg-block"><a class="btn btn-primary" href="/about">Learn more about <b>Agapay</b>Aid</a></p>
                    </div>
                </div>
            </div>
            <div class="carousel-item active">
                <img src="/images/ec2img.png" class="d-block w-100" alt="EC2 Image">
                <div class="carousel-caption text-start">
                    <div class="col-lg-6 col-md-12 p-lg-5 mx-auto my-5">
                        <h1 class="text-white d-none d-sm-block">“Together, we stand stronger in the face of adversity.”</h1>
                        <br class="d-none d-lg-block" />
                        <p class="d-none d-lg-block">
                            Agapay Aid is a web-based application dedicated to aiding the disaster relief efforts in the Philippines.
                            Our application streamlines the management of evacuation centers, ensuring efficient resource allocation, equitable relief goods distribution, staff coordination, and seamless registration of evacuees.
                        </p>
                        <br class="d-none d-lg-block" />
                        <p class="d-none d-lg-block"><a class="btn btn-primary" href="/about">Learn more about <b>Agapay</b>Aid</a></p>
                    </div>
                </div>
            </div>
            <div class="carousel-item">
                <img src="/images/ec3img.png" class="d-block w-100" alt="EC3 Image">
                <div class="carousel-caption text-start">
                    <div class="col-lg-6 col-md-12 p-lg-5 mx-auto my-5">
                        <h1 class="text-white d-none d-sm-block">“Together, we stand stronger in the face of adversity.”</h1>
                        <br class="d-none d-lg-block" />
                        <p class="d-none d-lg-block">
                            Agapay Aid is a web-based application dedicated to aiding the disaster relief efforts in the Philippines.
                            Our application streamlines the management of evacuation centers, ensuring efficient resource allocation, equitable relief goods distribution, staff coordination, and seamless registration of evacuees.
                        </p>
                        <br class="d-none d-lg-block" />
                        <p class="d-none d-lg-block"><a class="btn btn-primary" href="/about">Learn more about <b>Agapay</b>Aid</a></p>
                    </div>
                </div>
            </div>
        </div>
        <button class="carousel-control-prev" type="button" data-bs-target="#myCarousel" data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Previous</span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#myCarousel" data-bs-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Next</span>
        </button>
    </div>
}

<div class="container form-container1">
    <div class="container form-container-content1">
        <!-- Title, Info Button, Menu Button -->
        <div class="row">
            <div class="col-12 d-flex align-items-center justify-content-between">
                <h1>@Model.disasterInfo.disasterName</h1>

                <div class="d-flex gap-2 justify-content-end align-items-center">
                    <!-- Button with text and icon (visible on larger screens) -->
                    <button class="btn btn-primary d-none d-md-inline-block text-white"
                            onclick="showInfo('@Model.disasterInfo.disasterType', '@Model.disasterInfo.description', '@Model.disasterInfo.dateOccured')"
                            data-bs-toggle="modal" data-bs-target="#infoModal">
                        <i class="bi bi-info-circle-fill" style="padding-right: 5px;"></i> Info
                    </button>

                    <!-- Button with icon only (visible on smaller screens) -->
                    <button class="btn btn-primary d-inline-block d-md-none text-white"
                            onclick="showInfo('@Model.disasterInfo.disasterType', '@Model.disasterInfo.description', '@Model.disasterInfo.dateOccured')"
                            data-bs-toggle="modal" data-bs-target="#infoModal">
                        <i class="bi bi-info-circle-fill"></i>
                    </button>

                    <!-- Button with text and icon (visible on larger screens) -->
                    <a href="/disaster/profile/index?disasterID=@Model.disasterInfo.disasterID" class="btn btn-primary d-none d-md-inline-block position-relative" role="button">
                        View More <i class="bi bi-arrow-right-circle" style="padding-left: 5px;"></i>
                    </a>

                    <!-- Button with text and icon (visible on smaller screens) -->
                    <a href="/disaster/profile/index?disasterID=@Model.disasterInfo.disasterID" class="btn btn-primary d-inline-block d-md-none" role="button">
                        <i class="bi bi-arrow-right-circle"></i>
                    </a>                  
                </div>
            </div>
        </div>
    </div>

    <div class="dashcontent">
        <div class="boxinfo">
            <div class="infoitem">
                <i class="bi bi-people"></i>
                <div class="text">
                    <h3 class="dashtitle">@Model.dashboardInfo.totalDistinctEvacuees</h3>
                    <p><b>Total Evacuees</b></p>
                    <div class="box-stat">
                        <small>Check-in: <span>@Model.dashboardInfo.totalCheckIn</span></small>
                        <small>Check-out: <span>@Model.dashboardInfo.totalCheckOut</span></small>
                    </div>
                </div>
            </div>

            <div class="infoitem">
                <i class="bi bi-buildings-fill"></i>
                <div class="text">
                    <h3 class="dashtitle">@Model.dashboardInfo.totalDistinctBarangays</h3>
                    <p><b>Total Affected Brgys</b></p>
                    <div class="box-stat">
                        <small>Families: <span>@Model.dashboardInfo.totalDistinctFamilies</span></small><br />
                        <small>Male: <span>@Model.dashboardInfo.totalDistinctFemale</span></small>
                        <small>Female: <span>@Model.dashboardInfo.totalDistinctMale</span></small>
                    </div>
                </div>
            </div>

            <div class="infoitem">
                <i class="bi bi-building-fill"></i>
                <div class="text">
                    <h3 class="dashtitle">@Model.dashboardInfo.totalCenter</h3>
                    <p><b>Total Evacuation Centers</b></p>
                    <div class="box-stat">
                        <small>Open: <span>@Model.dashboardInfo.totalOpenCenter</span></small>
                        <small>Closed: <span>@Model.dashboardInfo.totalClosedCenter</span></small>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<div class="container form-container1">
    <div class="container form-container-content1">
        <div>
            <h2>Evacuation Center</h2>
        </div>
    </div>

    <!-- Table -->
    <div class="row p-2">
        <div class="col-lg-12">
            <div class="container table-container">
                <table id="ec" class="table display compact order-column table-hover" cellspacing="0" width="100%">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Name</th>
                            <th>Barangay</th>
                            <th>Occupancy</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        @{
                            var counter = 1;
                        }
                        @foreach (var item in Model.listCenterLog)
                        {
                            <tr>
                                <td width="5%">@counter</td>
                                <td width="25%" style="text-align: left;">@item.centerName</td>
                                <td width="25%" style="text-align: center;">@item.barangayName</td>
                                <td width="30%" style="text-align: center;">
                                    <div class="progress-container">
                                        <!-- Progress bar will be added dynamically here -->
                                    </div>
                                    <span class="occupancy-text">@item.occupancy/@item.maxCapacity</span>
                                </td>
                                <td width="15%" style="text-align: center;">
                                    @if (@item.status == "Open")
                                    {
                                        <span class="badge rounded-pill bg-success">@item.status</span>
                                    }
                                    else if (@item.status == "Closed")
                                    {
                                        <span class="badge rounded-pill bg-light">@item.status</span>
                                    }
                                </td>
                            </tr>
                            counter++;
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <div class="p-4 p-md-5 mb-4 text-white rounded bg-primary text-center d-lg-none d-lg-none">
        <!-- This content will be hidden on medium and larger screens -->
        <div class="col-md-6 mx-auto">
            <h1><img src="/white-logo-horizontal.png" alt="" id="logo"></h1>
            <p class="lead my-3">Together, we stand stronger in the face of adversity.</p>
            <a class="btn btn-outline-secondary text-white" href="/about">Learn More about <b>Agapay</b>Aid</a>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        var table = $('#ec').DataTable({
            responsive: true,
            pageLength: 25,
            columnDefs: [
                { "orderable": true, "targets": [0, 1] }, //Sortable columns
                { "orderable": false, "targets": [2, 3, 4] } // Non-sortable columns
            ],
            initComplete: function () {
                var rows = this.api().rows({ page: 'current' }).nodes();

                for (var i = 0; i < rows.length; i++) {
                    updateOccupancyBar(rows[i]);
                }
            }
        });

        function updateOccupancyBar(row) {
            var occupancyCell = row.cells[3];
            var occupancyText = occupancyCell.textContent.trim();
            var occupancyValues = occupancyText.split('/');
            var occupancy = parseInt(occupancyValues[0]);
            var totalCapacity = parseInt(occupancyValues[1]);
            var percentage = (occupancy / totalCapacity) * 100;

            var progressBar = document.createElement('div');
            progressBar.className = 'progress-bar';

            if (percentage > 100) {
                progressBar.style.backgroundColor = '#FF5A57';
            }

            progressBar.style.width = percentage + '%';

            var progressContainer = document.createElement('div');
            progressContainer.className = 'progress';
            progressContainer.appendChild(progressBar);

            occupancyCell.innerHTML = ''; // Clear existing content
            occupancyCell.appendChild(progressContainer);
            occupancyCell.insertAdjacentHTML('beforeend', occupancyText);
        }
    });
</script>

<!-- Modal: Disaster Information -->
<div class="modal fade" id="infoModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Disaster Information</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <table>
                    <tr>
                        <th class="text-start pe-4">Type</th>
                        <td id="disasterType" class="text-start"></td>
                    </tr>
                    <tr>
                        <th class="text-start pe-4">Description</th>
                        <td id="description" class="text-start"></td>
                    </tr>
                    <tr>
                        <th class="text-start pe-4">Date Occurred</th>
                        <td id="dateOccured" class="text-start"></td>
                    </tr>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Disaster Information Modal -->
<script>
    function showInfo(disasterType, description, dateOccured) {
        // Set the content of the modal with the provided info
        document.getElementById('disasterType').innerText = disasterType;
        document.getElementById('description').innerText = description;
        document.getElementById('dateOccured').innerText = dateOccured;
    }
</script>

<!-- SLIDER -->
<script>
    var imageSlider = document.getElementById('imageSlider');
    var autoPlayInterval;
    var currentSlide = 0;
    var isDragging = false;
    var startX;
    var scrollLeftAtStart;

    // Function to start auto-play
    function startAutoPlay() {
        autoPlayInterval = setInterval(function () {
            // Increment the current slide index
            currentSlide++;

            // Reset to the first slide if reached the end
            if (currentSlide >= imageSlider.children.length) {
                currentSlide = 0;
            }

            // Scroll to the next image
            imageSlider.scrollLeft = currentSlide * imageSlider.offsetWidth;
        }, 3500); // Adjust the interval (in milliseconds) for the auto-play speed
    }

    // Start auto-play when the page loads
    startAutoPlay();

    // Pause auto-play when the user interacts with the slider
    imageSlider.addEventListener('mousedown', function (e) {
        isDragging = true;
        startX = e.pageX - imageSlider.offsetLeft;
        scrollLeftAtStart = imageSlider.scrollLeft;
        clearInterval(autoPlayInterval);
    });

    // Resume auto-play after the user releases the slider
    imageSlider.addEventListener('mouseup', function () {
        isDragging = false;
        startAutoPlay();
    });

    // Handle drag movement
    imageSlider.addEventListener('mousemove', function (e) {
        if (!isDragging) return;

        e.preventDefault();

        var x = e.pageX - imageSlider.offsetLeft;
        var walk = (x - startX) * 3;
        imageSlider.scrollLeft = scrollLeftAtStart - walk;
    });

    // Disable the browser's drag-and-drop behavior on the images
    imageSlider.addEventListener('dragstart', function (e) {
        e.preventDefault();
    });

    // Handle click on slider-nav links
    var sliderNav = document.querySelector('.slider-nav');
    sliderNav.addEventListener('click', function (e) {
        if (e.target.tagName === 'A') {
            e.preventDefault();

            // Find the index of the clicked slide
            var index = Array.from(sliderNav.children).indexOf(e.target);

            // Scroll to the corresponding image with a smooth transition
            imageSlider.scrollLeft = index * imageSlider.offsetWidth;
        }
    });
</script>

