@page
@model AgapayAidSystem.Pages.Disaster.Profile.ReportModel
@{
    ViewData["Title"] = "Report";
}

<style>
    .table {
        margin: 0 auto; /* Center-align the table */
        text-align: center; /* Left-align the table contents */
        border-radius: 20px;
    }

        .table th {
            vertical-align: middle;
        }

        .table th {
            background: #3F8F8B;
            color: #fff;
        }

    /* Adjust the left-aligned text in the first column */
    .left-aligned {
        text-align: left;
    }

    .report-container {
        display: flex;
        justify-content: space-between;
        padding: 10px;
    }

    .col, .col-auto {
        flex: 1;
    }
</style>

<!-- Alert Banners -->
@if (!string.IsNullOrEmpty(Request.Query["successMessage"]))
{
    <div id="success-notification" class="position-fixed top-0 end-0 p-3" style="z-index: 1000;">
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <strong>@Request.Query["successMessage"]</strong>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    </div>

    <script>
        const successNotification = document.getElementById('success-notification');
        if (successNotification) {
            setTimeout(function () {
                successNotification.style.display = 'none';
            }, 5000); // 5000 milliseconds = 5 seconds
        }
    </script>
}

@if (!string.IsNullOrEmpty(Model.errorMessage))
{
    <div class="position-fixed top-0 end-0 p-3" style="z-index: 1000;">
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
            <strong>Error: @Model.errorMessage</strong>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    </div>
}

@if (!string.IsNullOrEmpty(Request.Query["errorMessage"]))
{
    <div class="position-fixed top-0 end-0 p-3" style="z-index: 1000;">
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
            <strong>Error: @Request.Query["errorMessage"]</strong>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    </div>
}

<div class="content" id="makepdf">
    <p class="row">
        <div class="col-6 themed-grid-col">
            <a class="navbar-brand pb-2">
                <img src="/greenlogo.svg" alt="" height="45" id="logo">
            </a>

            <a class="navbar-brand pb-2">
                <img src="/govlogo.jpg" alt="" height="45" id="logo">
            </a>
        </div>
        <div class="col-6 themed-grid-col">
            <p><b>Date of Report Generated:</b> <span id="currentDate"></span></p>
            <p><b>Generated by:</b> UserID</p>
        </div>
</div>

<hr />
<br />

<input type="hidden" name="centerLogID" value="@Model.disasterInfo.disasterID" />

<div class="row mb-3 text-start">
    <div class="col-6 themed-grid-col"><b>Province: </b>Cavite, Philippines</div>
    <div class="col-6 themed-grid-col"><b>City: </b>City of Imus</div>
</div>

<br />

<!--DISASTER INFORMATION-->
<div>
    <h4 class="pb-2"><strong>DISASTER INFORMATION:</strong></h4>
    <table class="display compact order-column table-hover" cellspacing="0" width="100%">
        <tr>
            <th class="text-start">ID</th>
            <td class="text-start">@Model.disasterInfo.disasterID</td>
        </tr>
        <tr>
            <th class="text-start pe-4">NAME</th>
            <td class="text-start">@Model.disasterInfo.disasterName</td>
        </tr>
        <tr>
            <th class="text-start">TYPE</th>
            <td class="text-start">@Model.disasterInfo.disasterType</td>
        </tr>
        <tr>
            <th class="text-start">DESCRIPTION</th>
            <td class="text-start"> @Model.disasterInfo.description</td>
        </tr>
        <tr>
            <th class="text-start">DATE OCCURRED</th>
            <td class="text-start"> @Model.disasterInfo.dateOccured</td>
        </tr>
    </table>
</div>

<br />

<!--EVACUATION INFORMATION-->
<div>
    <h4 class="pb-2"><strong>EVACUATION CENTER USED:</strong></h4>
    <table class="table display compact order-column table-hover" cellspacing="0" width="100%">
        <thead>
            <tr style="vertical-align: top;">
                <th width="5%">#</th>
                <th width="25%">Evacuation Center</th>
                <th width="11%">Occupancy</th>
                <th width="15%">Opening Time</th>
                <th width="15%">Closing Time</th>
                <th width="15%">Barangay</th>
                <th width="14%">Total Staff</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model.listCenterLog)
            {
                <tr>
                    <td>@item.centerID</td>
                    <td>@item.centerName</td>
                    <td>@item.occupancy</td>
                    <td>@item.openingDateTime</td>
                    <td>@item.closingDateTime</td>
                    <td>@item.barangayName</td>
                    <td>@item.totalStaff</td>
                </tr>
            }
        </tbody>
    </table>
</div>

<br />

<!--REMAINING INVENTORY COUNT-->
<div>
    <h4 class="pb-2"><strong>REMAINING INVENTORY COUNT:</strong></h4>
    <table id="inventory-table" class="table display compact order-column table-hover" cellspacing="0" width="100%">
        <thead>
            <tr>
                <th width="5%">#</th>
                <th width="15%">Disaster</th>
                <th width="25%">Evacuation Center</th>
                <th width="20%">Item</th>
                <th width="15%">Type</th>
                <th width="10%">Remaining Qty</th>
                <th width="10%">Unit Measure</th>
                <th width="5%"></th>
            </tr>
        </thead>
        <tbody>
            @{
                var counter = 1;
            }
            @foreach (var item in Model.listInventory)
            {
                @if (int.Parse(item.remainingQty) > 0)
                {
                    <tr style="font-weight:bold;">
                        <td>@counter</td>
                        <td>@item.disasterName</td>
                        <td>@item.centerName</td>
                        <td>@item.itemName</td>
                        <td>@item.itemType</td>
                        <td>@item.remainingQty</td>
                        <td>@item.unitMeasure</td>
                    </tr>
                }
                else
                {
                    <tr>
                        <td>@counter</td>
                        <td>@item.disasterName</td>
                        <td>@item.centerName</td>
                        <td>@item.itemName</td>
                        <td>@item.itemType</td>
                        <td>@item.remainingQty</td>
                        <td>@item.unitMeasure</td>
                    </tr>
                }
                counter++;
            }
        </tbody>
    </table>
</div>

<div>
    <h4 class="pb-2"><strong>STATUS OF DISASTER OPERATIONS:</strong></h4>
    <table class="table table-bordered">
        <thead>
            <tr>
                <th class="center-header" rowspan="4">AFFECTED BARANGAY</th>
                <th colspan="3" rowspan="3">NUMBER AFFECTED</th>
                <th colspan="2" rowspan="3">NUMBER OF ECs</th>
                <th colspan="4">SERVED</th>
                <th colspan="4" rowspan="3">TOTAL SERVED</th>
            </tr>
            <tr>
                <th colspan="4">Inside E.C</th>
            </tr>
            <tr>
                <th>Families</th>
                <th>Persons</th>

                <th>Families</th>
                <th>Persons</th>
            </tr>
            <tr>
                <th>Barangay</th>
                <th>Families</th>
                <th>Persons</th>

                <th>Cum</th>
                <th>Now</th>

                <th>Cum</th>
                <th>Now</th>

                <th>Cum</th>
                <th>Now</th>

                <th>Cum</th>
                <th>Now</th>

                <th>Cum</th>
                <th>Now</th>
            </tr>

        </thead>

        <tbody>
            <tr>
                <td>Barangay A</td>
                <td>50</td>
                <td>60</td>
                <td>30</td>
                <td>80</td>
                <td>10</td>
                <td>20</td>
                <td>20</td>
                <td>20</td>
                <td>20</td>
                <td>20</td>
                <td>20</td>
                <td>20</td>
                <td>20</td>
            </tr>
            <tr>
                <td>Barangay B</td>
                <td>50</td>
                <td>60</td>
                <td>30</td>
                <td>80</td>
                <td>10</td>
                <td>20</td>
                <td>20</td>
                <td>20</td>
                <td>20</td>
                <td>20</td>
                <td>20</td>
                <td>20</td>
                <td>20</td>
            </tr>
            <tr>
                <td>Barangay B</td>
                <td>50</td>
                <td>60</td>
                <td>30</td>
                <td>80</td>
                <td>10</td>
                <td>20</td>
                <td>20</td>
                <td>20</td>
                <td>20</td>
                <td>20</td>
                <td>20</td>
                <td>20</td>
                <td>20</td>
            </tr>
        </tbody>

        <tfoot>
            <tr>
                <th>SUB-TOTAL</th>
                <th></th>
                <th></th>
                <th></th>
                <th></th>
                <th></th>
                <th></th>
                <th></th>
                <th></th>
                <th></th>
                <th></th>
                <th></th>
                <th></th>
                <th></th>
            </tr>
        </tfoot>
    </table>
</div>
</div>

<div class="content">
    <input type="hidden" name="disasterID" value="@Model.disasterInfo.disasterID" />
    <a href="/disaster/profile/index?disasterID=@Model.disasterInfo.disasterID" role="button" class="btn btn-secondary">Go Back</a>
    <button class="btn btn-primary" id="button">Save as PDF</button>
</div>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.5.3/jspdf.min.js"></script>
<script type="text/javascript" src="https://html2canvas.hertzen.com/dist/html2canvas.js"></script>

<script>
    // Create PDF from HTML...
    function CreatePDFfromHTML() {
        var HTML_Width = $("#makepdf").width();
        var HTML_Height = $("#makepdf").height();
        var top_left_margin = 15;
        var PDF_Width = HTML_Width + (top_left_margin * 2);
        var PDF_Height = HTML_Height + (top_left_margin * 2);
        var canvas_image_width = HTML_Width;
        var canvas_image_height = HTML_Height;

        var totalPDFPages = Math.ceil(HTML_Height / PDF_Height) - 1;

        html2canvas($("#makepdf")[0]).then(function (canvas) {
            var imgData = canvas.toDataURL("image/jpeg", 1.0);
            var pdf = new jsPDF('l', 'pt', [PDF_Width, PDF_Height]); // 'l' for landscape
            pdf.addImage(imgData, 'JPG', top_left_margin, top_left_margin, canvas_image_width, canvas_image_height);
            for (var i = 1; i <= totalPDFPages; i++) {
                pdf.addPage('l', 'pt', [PDF_Width, PDF_Height]);
                pdf.addImage(imgData, 'JPG', top_left_margin, -(PDF_Height * i) + (top_left_margin * 4), canvas_image_width, canvas_image_height);
            }
            pdf.save("Agapay Aid Report.pdf");
            $("#makepdf").show(); // Show the content after generating PDF
        });
    }

    // Add event listener to the button
    document.getElementById('button').addEventListener('click', function () {
        CreatePDFfromHTML();
    });
</script>

<script>
    // Get today's date
    const today = new Date();
    const dateOptions = { year: 'numeric', month: '2-digit', day: '2-digit' };
    const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit' };

    // Format the date and time
    const formattedDate = today.toLocaleDateString('en-US', dateOptions);
    const formattedTime = today.toLocaleTimeString('en-US', timeOptions);

    // Display the formatted date and time
    const currentDateElement = document.getElementById('currentDate');
    currentDateElement.textContent = `${formattedDate} ${formattedTime}`;
</script>