@page
@model AgapayAidSystem.Pages.Disaster.Profile.ReportModel
@{
	ViewData["Title"] = "Report";
}

<style>
    .table {
        margin: 0 auto; /* Center-align the table */
        text-align: center; /* Left-align the table contents */
        border-radius: 20px;
    }

        .table th {
            vertical-align: middle;
        }

        .table th {
            background: #3F8F8B;
            color: #fff;
        }

    /* Adjust the left-aligned text in the first column */
    .left-aligned {
        text-align: left;
    }

    .report-container {
        display: flex;
        justify-content: space-between;
        padding: 10px;
    }

    .col, .col-auto {
        flex: 1;
    }
</style>

<!-- Alert Banners -->
@if (!string.IsNullOrEmpty(Request.Query["successMessage"]))
{
    <div id="success-notification" class="position-fixed top-0 end-0 p-3" style="z-index: 1000;">
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <strong>@Request.Query["successMessage"]</strong>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    </div>

    <script>
        const successNotification = document.getElementById('success-notification');
        if (successNotification) {
            setTimeout(function () {
                successNotification.style.display = 'none';
            }, 5000); // 5000 milliseconds = 5 seconds
        }
    </script>
}

@if (!string.IsNullOrEmpty(Model.errorMessage))
{
    <div class="position-fixed top-0 end-0 p-3" style="z-index: 1000;">
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
            <strong>Error: @Model.errorMessage</strong>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    </div>
}

@if (!string.IsNullOrEmpty(Request.Query["errorMessage"]))
{
    <div class="position-fixed top-0 end-0 p-3" style="z-index: 1000;">
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
            <strong>Error: @Request.Query["errorMessage"]</strong>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    </div>
}

<div class="content" id="makepdf">
    <a class="navbar-brand pb-2">
        <img src="/green-logo-horizontal.png" alt="" height="45" id="logo">
    </a>

    <hr /><br />

    <input type="hidden" name="centerLogID" value="@Model.disasterInfo.disasterID" />

    
    <div class="row">
        <!-- REPORT INFORMATION -->
        <div class="col left-aligned order-1">
            <p><b>Province: </b>Cavite</p>
            <p><b>City/Municipality: </b>City of Imus</p>
        </div>
        <div class="col-auto left-aligned order-2">
            <p><b>Date of Report Generated:</b> <span id="currentDate"></span></p>
            <p><b>Generated by:</b> John Doe</p>
        </div>
    </div>

    <br />

    <!-- SITUATION OVERVIEW -->
    <div>
        <h4 class="pb-2"><strong>SITUATION OVERVIEW</strong></h4>
        <table class="display compact order-column table-hover" cellspacing="0" width="30%">
            <tr>
                <th class="text-start pe-4">NAME</th>
                <td class="text-start">@Model.disasterInfo.disasterName</td>
            </tr>
            <tr>
                <th class="text-start">TYPE</th>
                <td class="text-start">@Model.disasterInfo.disasterType</td>
            </tr>
            <tr>
                <th class="text-start">DESCRIPTION</th>
                <td class="text-start"> @Model.disasterInfo.description</td>
            </tr>
            <tr>
                <th class="text-start">DATE OCCURRED</th>
                <td class="text-start"> @Model.disasterInfo.dateOccured</td>
            </tr>
        </table>
    </div>

    <br />

    <!-- EVACUATION CENTERS USED -->
    <div>
        <h4 class="pb-2"><strong>EVACUATION CENTERS USED</strong></h4>
        <table class="table display compact order-column" cellspacing="0" width="100%">
            <thead>
                <tr style="vertical-align: top;">
                    <th width="5%">#</th>
                    <th width="25%">Evacuation Center</th>
                    <th width="11%">Occupancy</th>
                    <th width="15%">Opening Time</th>
                    <th width="15%">Closing Time</th>
                    <th width="15%">Barangay</th>
                    <th width="14%">Total Staff</th>
                </tr>
            </thead>
            <tbody>
                @{
                    var counter = 1;
                }
                @foreach (var item in Model.listCenterLog)
                {
                    <tr>
                        <td>@counter</td>
                        <td>@item.centerName</td>
                        <td>@item.occupancy</td>
                        <td>@item.openingDateTime</td>
                        <td>@item.closingDateTime</td>
                        <td>@item.barangayName</td>
                        <td>@item.totalStaff</td>
                    </tr>
                    counter++;
                }
            </tbody>
        </table>
    </div>

    <br />

    <div>
        <h4 class="pb-2"><strong>STATUS OF DISASTER OPERATIONS</strong></h4>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th class="center-header" rowspan="2">AFFECTED BARANGAYS</th>
                    <th colspan="2">NUMBER OF AFFECTED</th>
                    <th colspan="2">NUMBER SERVED INSIDE EVACUATION CENTER</th>
                </tr>                
                <tr>
                    <th>Families</th>
                    <th>Persons</th>

                    <th>Families</th>
                    <th>Persons</th>
                </tr>
            </thead>

            <tbody>
                <tr>
                    <td>Barangay A</td>
                    <td>50</td>
                    <td>60</td>
                    <td>30</td>
                    <td>80</td>
                </tr>
                <tr>
                    <td>Barangay B</td>
                    <td>50</td>
                    <td>60</td>
                    <td>30</td>
                    <td>80</td>
                </tr>
                <tr>
                    <td>Barangay C</td>
                    <td>50</td>
                    <td>60</td>
                    <td>30</td>
                    <td>80</td>
                </tr>
            </tbody>

            <tfoot>
                <tr>
                    <th>SUB-TOTAL</th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                </tr>
            </tfoot>
        </table>
    </div>
</div>

<div class="content">
    <input type="hidden" name="disasterID" value="@Model.disasterInfo.disasterID" />
    <a href="/disaster/profile/index?disasterID=@Model.disasterInfo.disasterID" role="button" class="btn btn-secondary">Go Back</a>
    <button class="btn btn-primary" id="button">Save as PDF</button>
</div>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.5.3/jspdf.min.js"></script>
<script type="text/javascript" src="https://html2canvas.hertzen.com/dist/html2canvas.js"></script>

<script>
    // Create PDF from HTML...
    function CreatePDFfromHTML() {
        var HTML_Width = $("#makepdf").width();
        var HTML_Height = $("#makepdf").height();
        var top_left_margin = 15;
        var PDF_Width = HTML_Width + (top_left_margin * 2);
        var PDF_Height = HTML_Height + (top_left_margin * 2);
        var canvas_image_width = HTML_Width;
        var canvas_image_height = HTML_Height;

        var totalPDFPages = Math.ceil(HTML_Height / PDF_Height) - 1;

        html2canvas($("#makepdf")[0]).then(function (canvas) {
            var imgData = canvas.toDataURL("image/jpeg", 1.0);
            var pdf = new jsPDF('l', 'pt', [PDF_Width, PDF_Height]); // 'l' for landscape
            pdf.addImage(imgData, 'JPG', top_left_margin, top_left_margin, canvas_image_width, canvas_image_height);
            for (var i = 1; i <= totalPDFPages; i++) {
                pdf.addPage('l', 'pt', [PDF_Width, PDF_Height]);
                pdf.addImage(imgData, 'JPG', top_left_margin, -(PDF_Height * i) + (top_left_margin * 4), canvas_image_width, canvas_image_height);
            }
            pdf.save("Agapay Aid Report.pdf");
            $("#makepdf").show(); // Show the content after generating PDF
        });
    }

    // Add event listener to the button
    document.getElementById('button').addEventListener('click', function () {
        CreatePDFfromHTML();
    });
</script>

<script>
    // Get today's date
    const today = new Date();
    const dateOptions = { year: 'numeric', month: '2-digit', day: '2-digit' };
    const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit' };

    // Format the date and time
    const formattedDate = today.toLocaleDateString('en-US', dateOptions);
    const formattedTime = today.toLocaleTimeString('en-US', timeOptions);

    // Display the formatted date and time
    const currentDateElement = document.getElementById('currentDate');
    currentDateElement.textContent = `${formattedDate} ${formattedTime}`;
</script>